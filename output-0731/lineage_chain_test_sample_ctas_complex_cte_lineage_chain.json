{
  "sql": "\n         CREATE TABLE premium_customer_analysis AS\n         WITH order_stats AS (\n             SELECT \n                 customer_id,\n                 COUNT(*) as total_orders,\n                 SUM(order_total) as lifetime_value,\n                 AVG(order_total) as avg_order_value,\n                 MAX(order_date) as last_order_date\n             FROM orders \n             WHERE order_date >= '2023-01-01'\n             GROUP BY customer_id\n         ),\n         customer_segments AS (\n             SELECT \n                 u.id as customer_id,\n                 u.name,\n                 u.email,\n                 u.region,\n                 u.age,\n                 os.total_orders,\n                 os.lifetime_value,\n                 os.avg_order_value,\n                 os.last_order_date,\n                 CASE \n                     WHEN os.lifetime_value > 10000 THEN 'Platinum'\n                     WHEN os.lifetime_value > 5000 THEN 'Gold'\n                     WHEN os.lifetime_value > 2000 THEN 'Silver'\n                     ELSE 'Bronze'\n                 END as tier,\n                 ROW_NUMBER() OVER (\n                     PARTITION BY u.region \n                     ORDER BY os.lifetime_value DESC\n                 ) as region_rank\n             FROM users u\n             INNER JOIN order_stats os ON u.id = os.customer_id\n             WHERE u.active = true\n         )\n         SELECT \n             customer_id,\n             name,\n             email,\n             region,\n             age,\n             total_orders,\n             lifetime_value,\n             avg_order_value,\n             last_order_date,\n             tier,\n             region_rank\n         FROM customer_segments \n         WHERE tier IN ('Platinum', 'Gold')\n           AND region_rank <= 10\n         ORDER BY lifetime_value DESC\n         ",
  "dialect": "trino",
  "chain_type": "downstream",
  "max_depth": "unlimited",
  "actual_max_depth": 0,
  "target_entity": null,
  "chains": {
    "orders": {
      "entity": "orders",
      "entity_type": "table",
      "depth": 0,
      "dependencies": [
        {
          "entity": "order_stats",
          "entity_type": "cte",
          "depth": 1,
          "dependencies": [
            {
              "entity": "customer_segments",
              "entity_type": "cte",
              "depth": 2,
              "dependencies": [
                {
                  "entity": "QUERY_RESULT",
                  "entity_type": "table",
                  "depth": 3,
                  "dependencies": [],
                  "metadata": {
                    "table_columns": [],
                    "is_cte": false
                  },
                  "transformations": [
                    {
                      "type": "table_transformation",
                      "source_table": "customer_segments",
                      "target_table": "QUERY_RESULT",
                      "filter_conditions": [
                        {
                          "type": "FILTER",
                          "conditions": [
                            {
                              "column": "region_rank",
                              "operator": "<=",
                              "value": "10"
                            }
                          ]
                        }
                      ],
                      "group_by_columns": [],
                      "joins": [
                        {
                          "join_type": "INNER JOIN",
                          "right_table": "order_stats",
                          "conditions": [
                            {
                              "left_column": "u.id",
                              "operator": "=",
                              "right_column": "os.customer_id"
                            }
                          ]
                        }
                      ],
                      "order_by_columns": [
                        "lifetime_value DESC"
                      ]
                    }
                  ]
                }
              ],
              "metadata": {
                "table_columns": [
                  {
                    "name": "customer_id",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "name",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "email",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "region",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "age",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "total_orders",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "lifetime_value",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "avg_order_value",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "last_order_date",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "tier",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "region_rank",
                    "upstream": [],
                    "type": "VARCHAR"
                  }
                ],
                "is_cte": true
              },
              "transformations": [
                {
                  "type": "table_transformation",
                  "source_table": "order_stats",
                  "target_table": "customer_segments",
                  "filter_conditions": [],
                  "group_by_columns": [],
                  "joins": []
                }
              ]
            }
          ],
          "metadata": {
            "table_columns": [
              {
                "name": "customer_id",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "total_orders",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "lifetime_value",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "avg_order_value",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "last_order_date",
                "upstream": [],
                "type": "VARCHAR"
              }
            ],
            "is_cte": true
          },
          "transformations": [
            {
              "type": "table_transformation",
              "source_table": "orders",
              "target_table": "order_stats",
              "filter_conditions": [
                {
                  "type": "FILTER",
                  "conditions": [
                    {
                      "column": "order_date",
                      "operator": ">=",
                      "value": "'2023-01-01'"
                    }
                  ]
                },
                {
                  "type": "GROUP_BY",
                  "columns": [
                    "customer_id"
                  ]
                }
              ],
              "group_by_columns": [],
              "joins": []
            }
          ]
        }
      ],
      "metadata": {
        "table_columns": [],
        "is_cte": false
      }
    },
    "users": {
      "entity": "users",
      "entity_type": "table",
      "depth": 0,
      "dependencies": [
        {
          "entity": "customer_segments",
          "entity_type": "cte",
          "depth": 1,
          "dependencies": [
            {
              "entity": "QUERY_RESULT",
              "entity_type": "table",
              "depth": 2,
              "dependencies": [],
              "metadata": {
                "table_columns": [],
                "is_cte": false
              },
              "transformations": [
                {
                  "type": "table_transformation",
                  "source_table": "customer_segments",
                  "target_table": "QUERY_RESULT",
                  "filter_conditions": [
                    {
                      "type": "FILTER",
                      "conditions": [
                        {
                          "column": "region_rank",
                          "operator": "<=",
                          "value": "10"
                        }
                      ]
                    }
                  ],
                  "group_by_columns": [],
                  "joins": [
                    {
                      "join_type": "INNER JOIN",
                      "right_table": "order_stats",
                      "conditions": [
                        {
                          "left_column": "u.id",
                          "operator": "=",
                          "right_column": "os.customer_id"
                        }
                      ]
                    }
                  ],
                  "order_by_columns": [
                    "lifetime_value DESC"
                  ]
                }
              ]
            }
          ],
          "metadata": {
            "table_columns": [
              {
                "name": "customer_id",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "name",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "email",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "region",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "age",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "total_orders",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "lifetime_value",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "avg_order_value",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "last_order_date",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "tier",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "region_rank",
                "upstream": [],
                "type": "VARCHAR"
              }
            ],
            "is_cte": true
          },
          "transformations": [
            {
              "type": "table_transformation",
              "source_table": "users",
              "target_table": "customer_segments",
              "filter_conditions": [
                {
                  "type": "FILTER",
                  "conditions": [
                    {
                      "column": "u.active",
                      "operator": "=",
                      "value": "TRUE"
                    }
                  ]
                }
              ],
              "group_by_columns": [],
              "joins": []
            }
          ]
        }
      ],
      "metadata": {
        "table_columns": [],
        "is_cte": false
      }
    }
  },
  "summary": {
    "total_tables": 5,
    "total_columns": 0,
    "has_transformations": true,
    "has_metadata": true,
    "chain_count": 2
  },
  "errors": [],
  "warnings": []
}