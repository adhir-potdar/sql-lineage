{
  "sql": "\n         WITH order_stats AS (\n             SELECT \n                 customer_id,\n                 COUNT(*) as order_count,\n                 SUM(total) as total_spent\n             FROM orders\n             WHERE order_date >= '2023-01-01'\n             GROUP BY customer_id\n         ),\n         customer_segments AS (\n             SELECT \n                 u.id,\n                 u.name,\n                 u.email,\n                 os.order_count,\n                 os.total_spent,\n                 CASE \n                     WHEN os.total_spent > 1000 THEN 'Premium'\n                     WHEN os.total_spent > 500 THEN 'Standard'\n                     ELSE 'Basic'\n                 END as segment\n             FROM users u\n             LEFT JOIN order_stats os ON u.id = os.customer_id\n         ),\n         segment_summary AS (\n             SELECT \n                 segment,\n                 COUNT(*) as customer_count,\n                 AVG(total_spent) as avg_spent\n             FROM customer_segments\n             GROUP BY segment\n         )\n         SELECT * FROM segment_summary ORDER BY avg_spent DESC\n         ",
  "dialect": "trino",
  "chain_type": "downstream",
  "max_depth": "unlimited",
  "actual_max_depth": 0,
  "target_entity": null,
  "chains": {
    "orders": {
      "entity": "orders",
      "entity_type": "table",
      "depth": 0,
      "dependencies": [
        {
          "entity": "order_stats",
          "entity_type": "cte",
          "depth": 1,
          "dependencies": [
            {
              "entity": "customer_segments",
              "entity_type": "cte",
              "depth": 2,
              "dependencies": [
                {
                  "entity": "segment_summary",
                  "entity_type": "cte",
                  "depth": 3,
                  "dependencies": [
                    {
                      "entity": "QUERY_RESULT",
                      "entity_type": "table",
                      "depth": 4,
                      "dependencies": [],
                      "metadata": {
                        "table_columns": [],
                        "is_cte": false
                      },
                      "transformations": [
                        {
                          "type": "table_transformation",
                          "source_table": "segment_summary",
                          "target_table": "QUERY_RESULT",
                          "filter_conditions": [],
                          "group_by_columns": [],
                          "joins": [
                            {
                              "join_type": "LEFT JOIN",
                              "right_table": "order_stats",
                              "conditions": [
                                {
                                  "left_column": "u.id",
                                  "operator": "=",
                                  "right_column": "os.customer_id"
                                }
                              ]
                            }
                          ],
                          "order_by_columns": [
                            "avg_spent DESC"
                          ]
                        }
                      ]
                    }
                  ],
                  "metadata": {
                    "table_columns": [
                      {
                        "name": "segment",
                        "upstream": [],
                        "type": "VARCHAR"
                      },
                      {
                        "name": "customer_count",
                        "upstream": [],
                        "type": "VARCHAR",
                        "transformation": {
                          "column_name": "customer_count",
                          "source_expression": "COUNT(*)",
                          "transformation_type": "COMPUTED",
                          "function_type": "COUNT",
                          "full_expression": "COUNT(*) AS customer_count"
                        }
                      },
                      {
                        "name": "avg_spent",
                        "upstream": [],
                        "type": "VARCHAR",
                        "transformation": {
                          "column_name": "avg_spent",
                          "source_expression": "AVG(total_spent)",
                          "transformation_type": "COMPUTED",
                          "function_type": "AVG",
                          "full_expression": "AVG(total_spent) AS avg_spent"
                        }
                      }
                    ],
                    "is_cte": true
                  },
                  "transformations": [
                    {
                      "type": "table_transformation",
                      "source_table": "customer_segments",
                      "target_table": "segment_summary",
                      "filter_conditions": [
                        {
                          "type": "GROUP_BY",
                          "columns": [
                            "segment"
                          ]
                        }
                      ],
                      "group_by_columns": [],
                      "joins": []
                    }
                  ]
                }
              ],
              "metadata": {
                "table_columns": [
                  {
                    "name": "id",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "name",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "email",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "order_count",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "total_spent",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "segment",
                    "upstream": [],
                    "type": "VARCHAR",
                    "transformation": {
                      "column_name": "segment",
                      "source_expression": "CASE WHEN os.total_spent > 1000 THEN 'Premium' WHEN os.total_spent > 500 THEN 'Standard' ELSE 'Basic' END",
                      "transformation_type": "CASE",
                      "function_type": "CASE",
                      "full_expression": "CASE WHEN os.total_spent > 1000 THEN 'Premium' WHEN os.total_spent > 500 THEN 'Standard' ELSE 'Basic' END AS segment"
                    }
                  }
                ],
                "is_cte": true
              },
              "transformations": [
                {
                  "type": "table_transformation",
                  "source_table": "order_stats",
                  "target_table": "customer_segments",
                  "filter_conditions": [],
                  "group_by_columns": [],
                  "joins": []
                }
              ]
            }
          ],
          "metadata": {
            "table_columns": [
              {
                "name": "customer_id",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "order_count",
                "upstream": [],
                "type": "VARCHAR",
                "transformation": {
                  "column_name": "order_count",
                  "source_expression": "COUNT(*)",
                  "transformation_type": "COMPUTED",
                  "function_type": "COUNT",
                  "full_expression": "COUNT(*) AS order_count"
                }
              },
              {
                "name": "total_spent",
                "upstream": [],
                "type": "VARCHAR",
                "transformation": {
                  "column_name": "total_spent",
                  "source_expression": "SUM(total)",
                  "transformation_type": "COMPUTED",
                  "function_type": "SUM",
                  "full_expression": "SUM(total) AS total_spent"
                }
              }
            ],
            "is_cte": true
          },
          "transformations": [
            {
              "type": "table_transformation",
              "source_table": "orders",
              "target_table": "order_stats",
              "filter_conditions": [
                {
                  "type": "FILTER",
                  "conditions": [
                    {
                      "column": "order_date",
                      "operator": ">=",
                      "value": "'2023-01-01'"
                    }
                  ]
                },
                {
                  "type": "GROUP_BY",
                  "columns": [
                    "customer_id"
                  ]
                }
              ],
              "group_by_columns": [],
              "joins": []
            }
          ]
        }
      ],
      "metadata": {
        "table_columns": [],
        "is_cte": false
      }
    },
    "users": {
      "entity": "users",
      "entity_type": "table",
      "depth": 0,
      "dependencies": [
        {
          "entity": "customer_segments",
          "entity_type": "cte",
          "depth": 1,
          "dependencies": [
            {
              "entity": "segment_summary",
              "entity_type": "cte",
              "depth": 2,
              "dependencies": [
                {
                  "entity": "QUERY_RESULT",
                  "entity_type": "table",
                  "depth": 3,
                  "dependencies": [],
                  "metadata": {
                    "table_columns": [],
                    "is_cte": false
                  },
                  "transformations": [
                    {
                      "type": "table_transformation",
                      "source_table": "segment_summary",
                      "target_table": "QUERY_RESULT",
                      "filter_conditions": [],
                      "group_by_columns": [],
                      "joins": [
                        {
                          "join_type": "LEFT JOIN",
                          "right_table": "order_stats",
                          "conditions": [
                            {
                              "left_column": "u.id",
                              "operator": "=",
                              "right_column": "os.customer_id"
                            }
                          ]
                        }
                      ],
                      "order_by_columns": [
                        "avg_spent DESC"
                      ]
                    }
                  ]
                }
              ],
              "metadata": {
                "table_columns": [
                  {
                    "name": "segment",
                    "upstream": [],
                    "type": "VARCHAR"
                  },
                  {
                    "name": "customer_count",
                    "upstream": [],
                    "type": "VARCHAR",
                    "transformation": {
                      "column_name": "customer_count",
                      "source_expression": "COUNT(*)",
                      "transformation_type": "COMPUTED",
                      "function_type": "COUNT",
                      "full_expression": "COUNT(*) AS customer_count"
                    }
                  },
                  {
                    "name": "avg_spent",
                    "upstream": [],
                    "type": "VARCHAR",
                    "transformation": {
                      "column_name": "avg_spent",
                      "source_expression": "AVG(total_spent)",
                      "transformation_type": "COMPUTED",
                      "function_type": "AVG",
                      "full_expression": "AVG(total_spent) AS avg_spent"
                    }
                  }
                ],
                "is_cte": true
              },
              "transformations": [
                {
                  "type": "table_transformation",
                  "source_table": "customer_segments",
                  "target_table": "segment_summary",
                  "filter_conditions": [
                    {
                      "type": "GROUP_BY",
                      "columns": [
                        "segment"
                      ]
                    }
                  ],
                  "group_by_columns": [],
                  "joins": []
                }
              ]
            }
          ],
          "metadata": {
            "table_columns": [
              {
                "name": "id",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "name",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "email",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "order_count",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "total_spent",
                "upstream": [],
                "type": "VARCHAR"
              },
              {
                "name": "segment",
                "upstream": [],
                "type": "VARCHAR",
                "transformation": {
                  "column_name": "segment",
                  "source_expression": "CASE WHEN os.total_spent > 1000 THEN 'Premium' WHEN os.total_spent > 500 THEN 'Standard' ELSE 'Basic' END",
                  "transformation_type": "CASE",
                  "function_type": "CASE",
                  "full_expression": "CASE WHEN os.total_spent > 1000 THEN 'Premium' WHEN os.total_spent > 500 THEN 'Standard' ELSE 'Basic' END AS segment"
                }
              }
            ],
            "is_cte": true
          },
          "transformations": [
            {
              "type": "table_transformation",
              "source_table": "users",
              "target_table": "customer_segments",
              "filter_conditions": [],
              "group_by_columns": [],
              "joins": []
            }
          ]
        }
      ],
      "metadata": {
        "table_columns": [],
        "is_cte": false
      }
    }
  },
  "summary": {
    "total_tables": 6,
    "total_columns": 0,
    "has_transformations": true,
    "has_metadata": true,
    "chain_count": 2
  },
  "errors": [],
  "warnings": []
}